---
layout: default
---

# Finding Vulnerability leading to CVE-2021-3156

# CVE Description

```text
Sudo before 1.9.5p2 contains an off-by-one error that can result in a heap-based buffer overflow,
which allows privilege escalation to root via "sudoedit -s" and a command-line argument that ends
with a single backslash character.
```

# Introduction

In this blog we will try to find the vulnerability leading to `CVE-2021-3156`. Originally this vulnerability was found using code audit by `Qualys`, but we will try to discover it using fuzzing and see how this vulnerability evaded detection for almost 10 years.

**NOTE:** For this blog we will be using `sudo v1.8.31`.

# Setup

We will try to find vulnerability using the `AFL++` fuzzer. But, in order to understand how to setup `sudo` for fuzzing let's disect the CVE decription first.

From the CVE description we can see that the vulnerability occurs when we use the `sudoedit` binary as opposed to `sudo`. Well it can be `blahblahedit` as long as long as last 4 characters are `edit`. We will look into why this is the case later in the blog. We also know that `sudoedit` requires a `-s` option followed by some characters that causes the crash. 

Do you see the problem here? AFL++ works best with applications that read from a `file` or `stdin`. But, here we need to fuzz the `command line arguments`. Fortunately, AFL++ provides code for doing exactly that. [argv_fuzzing](https://github.com/AFLplusplus/AFLplusplus/blob/78b7e14c73baacf1d88b3c03955e78f5080d17ba/utils/argv_fuzzing/README.md#L4).

Just add the following lines in `sudo.c` to enable argv fuzzing.

```c
#include "sudo.h"
#include "sudo_plugin.h"
#include "sudo_plugin_int.h"
#include "argv-fuzz-inl.h" // Include header file

/*
 * Local variables
 */
struct plugin_container policy_plugin;
struct plugin_container_list io_plugins = TAILQ_HEAD_INITIALIZER(io_plugins);

...

int
main(int argc, char *argv[], char *envp[])
{
    AFL_INIT_ARGV();  // enable argv_fuzzing
    int nargc, ok, status = 0;
    char **nargv, **env_add;
    char **user_info, **command_info, **argv_out, **user_env_out;
```

